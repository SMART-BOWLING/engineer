// Константы для работы с таблицами
const CONFIG = {
  SPREADSHEET_ID: '130GUmajAIeTtlb0tzpf_47ctTVaCrNfM3TSObj9jFWc'
};

/**
 * Обработчик всех запросов
 */
function doGet(e) {
  return handleRequest(e);
}

function doPost(e) {
  return handleRequest(e);
}

function handleRequest(e) {
  try {
    const action = e.parameter.action;
    
    if (action === 'getTasks') {
      return getTasks();
    } else if (action === 'getJournal') {
      return getJournal();
    } else if (action === 'updateCell') {
      const sheetName = e.parameter.sheetName;
      const column = e.parameter.column;
      const row = e.parameter.row;
      const value = e.parameter.value;
      return updateCell(sheetName, column, row, value);
    } else if (action === 'test') {
      return testConnection();
    } else {
      return ContentService.createTextOutput(JSON.stringify({success: false, error: 'Неизвестное действие'})).setMimeType(ContentService.MimeType.JSON);
    }
  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({success: false, error: error.toString()})).setMimeType(ContentService.MimeType.JSON);
  }
}

/**
 * Находит листы автоматически
 */
function findSheets() {
  try {
    const spreadsheet = SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID);
    const sheets = spreadsheet.getSheets();
    
    let tasksSheet = null;
    let journalSheet = null;
    
    // Ищем листы по содержимому заголовков
    for (let sheet of sheets) {
      const data = sheet.getDataRange().getValues();
      if (data.length === 0) continue;
      
      const headers = data[0].map(h => h.toString().toLowerCase());
      
      // Проверяем заголовки для списка задач
      if (headers.includes('номер задачи') && headers.includes('периодичность дней выполнения')) {
        tasksSheet = sheet;
      }
      // Проверяем заголовки для журнала выполнения
      else if (headers.includes('номер задачи') && headers.includes('выполнил')) {
        journalSheet = sheet;
      }
    }
    
    // Если не нашли по заголовкам, берем по порядку
    if (!tasksSheet && sheets.length > 0) {
      tasksSheet = sheets[0];
    }
    if (!journalSheet && sheets.length > 1) {
      journalSheet = sheets[1];
    }
    
    return {
      tasksSheet: tasksSheet,
      journalSheet: journalSheet,
      tasksSheetName: tasksSheet ? tasksSheet.getName() : null,
      journalSheetName: journalSheet ? journalSheet.getName() : null
    };
  } catch (error) {
    console.error('Ошибка при поиске листов:', error);
    return { tasksSheet: null, journalSheet: null, tasksSheetName: null, journalSheetName: null };
  }
}

/**
 * Получает список задач с расчетами
 */
function getTasks() {
  try {
    const { tasksSheet } = findSheets();
    
    if (!tasksSheet) {
      throw new Error('Лист с задачами не найден');
    }
    
    const data = tasksSheet.getDataRange().getValues();
    const headers = data[0];
    const rows = data.slice(1);
    
    // Определяем индексы колонок по заголовкам
    const colIndex = {
      ID: headers.findIndex(h => h.toString().toLowerCase().includes('номер')),
      TASK: headers.findIndex(h => h.toString().toLowerCase().includes('задача')),
      LAST_DATE: headers.findIndex(h => h.toString().toLowerCase().includes('последняя') && h.toString().toLowerCase().includes('дата')),
      FREQUENCY: headers.findIndex(h => h.toString().toLowerCase().includes('периодичность'))
    };
    
    // Если не нашли колонки, используем стандартные индексы
    if (colIndex.ID === -1) colIndex.ID = 0;
    if (colIndex.TASK === -1) colIndex.TASK = 1;
    if (colIndex.LAST_DATE === -1) colIndex.LAST_DATE = 2;
    if (colIndex.FREQUENCY === -1) colIndex.FREQUENCY = 4;
    
    const tasks = rows.map(row => {
      const today = new Date();
      const lastDate = row[colIndex.LAST_DATE];
      const frequency = parseFloat(row[colIndex.FREQUENCY]) || 0;
      
      let daysPassed = 0;
      let daysLeft = 0;
      let nextDate = '';
      
      if (lastDate instanceof Date && !isNaN(lastDate.getTime())) {
        // Расчет прошедших дней
        daysPassed = Math.floor((today - lastDate) / (1000 * 60 * 60 * 24));
        
        // Расчет оставшихся дней
        daysLeft = frequency - daysPassed;
        
        // Расчет даты следующего выполнения
        const nextDateObj = new Date(lastDate);
        nextDateObj.setDate(nextDateObj.getDate() + frequency);
        nextDate = Utilities.formatDate(nextDateObj, Session.getScriptTimeZone(), 'dd.MM.yyyy');
      }
      
      return {
        id: row[colIndex.ID],
        task: row[colIndex.TASK],
        lastDate: lastDate instanceof Date && !isNaN(lastDate.getTime()) ? 
          Utilities.formatDate(lastDate, Session.getScriptTimeZone(), 'dd.MM.yyyy') : '',
        daysPassed: daysPassed,
        frequency: frequency,
        daysLeft: daysLeft,
        nextDate: nextDate
      };
    }).filter(task => task.id && task.task); // Фильтруем пустые строки
    
    return ContentService.createTextOutput(JSON.stringify(tasks)).setMimeType(ContentService.MimeType.JSON);
  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({success: false, error: error.toString()})).setMimeType(ContentService.MimeType.JSON);
  }
}

/**
 * Получает журнал выполнения
 */
function getJournal() {
  try {
    const { journalSheet } = findSheets();
    
    if (!journalSheet) {
      throw new Error('Лист с журналом не найден');
    }
    
    const data = journalSheet.getDataRange().getValues();
    const headers = data[0];
    const rows = data.slice(1);
    
    // Определяем индексы колонок по заголовкам
    const colIndex = {
      ID: headers.findIndex(h => h.toString().toLowerCase().includes('номер')),
      TASK: headers.findIndex(h => h.toString().toLowerCase().includes('задача')),
      CREATED_DATE: headers.findIndex(h => h.toString().toLowerCase().includes('появления') && h.toString().toLowerCase().includes('дата')),
      COMPLETED_DATE: headers.findIndex(h => h.toString().toLowerCase().includes('выполнения') && h.toString().toLowerCase().includes('дата')),
      EXECUTOR: headers.findIndex(h => h.toString().toLowerCase().includes('выполнил'))
    };
    
    // Если не нашли колонки, используем стандартные индексы
    if (colIndex.ID === -1) colIndex.ID = 0;
    if (colIndex.TASK === -1) colIndex.TASK = 1;
    if (colIndex.CREATED_DATE === -1) colIndex.CREATED_DATE = 2;
    if (colIndex.COMPLETED_DATE === -1) colIndex.COMPLETED_DATE = 3;
    if (colIndex.EXECUTOR === -1) colIndex.EXECUTOR = 4;
    
    const journal = rows.map((row, index) => {
      const createdDate = row[colIndex.CREATED_DATE];
      const completedDate = row[colIndex.COMPLETED_DATE];
      const executor = row[colIndex.EXECUTOR];
      
      const isCompleted = completedDate instanceof Date && !isNaN(completedDate.getTime());
      
      return {
        id: row[colIndex.ID],
        task: row[colIndex.TASK],
        createdDate: createdDate instanceof Date && !isNaN(createdDate.getTime()) ? 
          Utilities.formatDate(createdDate, Session.getScriptTimeZone(), 'dd.MM.yyyy') : '',
        completedDate: isCompleted ? 
          Utilities.formatDate(completedDate, Session.getScriptTimeZone(), 'dd.MM.yyyy') : '',
        executor: executor || '',
        isCompleted: isCompleted,
        rowIndex: index + 2 // +2 потому что первая строка - заголовок, и индексы начинаются с 0
      };
    }).filter(item => item.id && item.task); // Фильтруем пустые строки
    
    // Сортируем: сначала невыполненные, потом выполненные
    const pending = journal.filter(item => !item.isCompleted);
    const completed = journal.filter(item => item.isCompleted);
    
    const sortedJournal = [...pending, ...completed];
    return ContentService.createTextOutput(JSON.stringify(sortedJournal)).setMimeType(ContentService.MimeType.JSON);
  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({success: false, error: error.toString()})).setMimeType(ContentService.MimeType.JSON);
  }
}

/**
 * Обновление ячейки
 */
function updateCell(sheetName, column, row, value) {
  try {
    const ss = SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID);
    let sheet;
    
    // Если sheetName = 'B' или '2', ищем журнал выполнения
    if (sheetName === 'B' || sheetName === '2') {
      const { journalSheet } = findSheets();
      sheet = journalSheet;
    } 
    // Если sheetName = 'A' или '1', ищем список задач
    else if (sheetName === 'A' || sheetName === '1') {
      const { tasksSheet } = findSheets();
      sheet = tasksSheet;
    }
    // Иначе ищем по имени
    else {
      sheet = ss.getSheetByName(sheetName);
    }
    
    if (!sheet) {
      return ContentService.createTextOutput(JSON.stringify({success: false, error: 'Лист не найден'})).setMimeType(ContentService.MimeType.JSON);
    }
    
    const range = sheet.getRange(column + row);
    range.setValue(value);
    
    // Если обновляем журнал выполнения в колонке E (исполнитель), 
    // то автоматически устанавливаем текущую дату в колонку D
    if ((sheetName === 'B' || sheetName === '2') && column === 'E' && value) {
      const dateRange = sheet.getRange('D' + row);
      dateRange.setValue(new Date());
    }
    
    return ContentService.createTextOutput(JSON.stringify({success: true})).setMimeType(ContentService.MimeType.JSON);
  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({success: false, error: error.toString()})).setMimeType(ContentService.MimeType.JSON);
  }
}

/**
 * Тестовая функция для проверки подключения
 */
function testConnection() {
  try {
    const spreadsheet = SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID);
    const sheets = spreadsheet.getSheets();
    const sheetNames = sheets.map(sheet => sheet.getName());
    
    const foundSheets = findSheets();
    
    return ContentService.createTextOutput(JSON.stringify({
      success: true,
      message: 'Подключение успешно',
      allSheets: sheetNames,
      tasksSheet: foundSheets.tasksSheetName,
      journalSheet: foundSheets.journalSheetName,
      tasksFound: !!foundSheets.tasksSheet,
      journalFound: !!foundSheets.journalSheet,
      spreadsheetUrl: spreadsheet.getUrl()
    })).setMimeType(ContentService.MimeType.JSON);
  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({
      success: false,
      error: error.message
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

/**
 * Функция для отладки - показывает все доступные листы
 */
function debugSheets() {
  try {
    const spreadsheet = SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID);
    const sheets = spreadsheet.getSheets();
    const sheetNames = sheets.map(sheet => sheet.getName());
    
    console.log('Доступные листы:', sheetNames);
    
    const foundSheets = findSheets();
    
    console.log('Найденные листы:');
    console.log('- Задачи:', foundSheets.tasksSheetName);
    console.log('- Журнал:', foundSheets.journalSheetName);
    
    if (foundSheets.tasksSheet) {
      const tasksData = foundSheets.tasksSheet.getDataRange().getValues();
      console.log('Данные листа задач:', tasksData);
    }
    
    if (foundSheets.journalSheet) {
      const journalData = foundSheets.journalSheet.getDataRange().getValues();
      console.log('Данные листа журнала:', journalData);
    }
    
    return {
      allSheets: sheetNames,
      foundSheets: foundSheets
    };
  } catch (error) {
    console.error('Ошибка при отладке:', error);
    return error.toString();
  }
}

/**
 * Простая функция для тестирования
 */
function testFunction() {
  return {
    status: 'ok',
    message: 'Сервер работает',
    timestamp: new Date().toISOString()
  };
}

/**
 * Получить URL веб-приложения
 */
function getWebAppUrl() {
  const scriptId = ScriptApp.getScriptId();
  return `https://script.google.com/macros/s/${scriptId}/exec`;
}
